{
  "id": "sxcb1pmVzDnwX4Hf",
  "name": "Workflow Backup to GitHub - CasaOS",
  "active": true,
  "createdAt": "2025-12-17T19:35:06.595Z",
  "updatedAt": "2025-12-19T21:40:22.458Z",
  "nodes": [
    {
      "parameters": {
        "rule": { "interval": [{ "field": "hours", "hoursInterval": 6 }] }
      },
      "id": "schedule-trigger",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [192, 304]
    },
    {
      "parameters": {
        "url": "http://localhost:5678/api/v1/workflows?limit=250",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "n8nApi",
        "options": {}
      },
      "id": "get-all-workflows",
      "name": "Get All Workflows",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [400, 304],
      "credentials": { "n8nApi": { "name": "n8n account" } }
    },
    {
      "parameters": {
        "jsCode": "// Get the workflows from the HTTP response\nconst response = $input.first();\n\nlet workflows = [];\nif (response.body?.data?.data) {\n  workflows = response.body.data.data;\n} else if (response.body?.data) {\n  workflows = response.body.data;\n} else if (response.json?.data) {\n  workflows = response.json.data;\n} else if (response.data) {\n  workflows = response.data;\n} else if (Array.isArray(response)) {\n  workflows = response;\n}\n\nconst timestamp = new Date().toISOString().split('T')[0];\nconst results = [];\n\nfor (const workflow of workflows) {\n  if (workflow.name === 'Workflow Backup to GitHub') {\n    continue;\n  }\n  \n  const safeName = workflow.name\n    .toLowerCase()\n    .replace(/[^a-z0-9]+/g, '-')\n    .replace(/^-|-$/g, '');\n  \n  const cleanWorkflow = {\n    ...workflow,\n    nodes: workflow.nodes?.map(node => {\n      const cleanNode = { ...node };\n      if (cleanNode.credentials) {\n        Object.keys(cleanNode.credentials).forEach(key => {\n          if (cleanNode.credentials[key]) {\n            cleanNode.credentials[key] = {\n              name: cleanNode.credentials[key].name\n            };\n          }\n        });\n      }\n      return cleanNode;\n    })\n  };\n  \n  const contentStr = JSON.stringify(cleanWorkflow, null, 2);\n  const contentBase64 = Buffer.from(contentStr).toString('base64');\n  \n  results.push({\n    json: {\n      filename: `workflows/${safeName}.json`,\n      content: contentBase64,\n      workflowName: workflow.name,\n      workflowId: workflow.id,\n      active: workflow.active\n    }\n  });\n}\n\nreturn results;"
      },
      "id": "process-workflows",
      "name": "Process Workflows",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [624, 304]
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://api.github.com/repos/dougkimmerly/homelab-n8n-workflows/contents/{{ $json.filename }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"message\": \"{{ $json.workflowName }} - {{ $now.format('yyyy-MM-dd HH:mm') }}\",\n  \"content\": \"{{ $json.content }}\",\n  \"branch\": \"main\"\n}",
        "options": { "response": { "response": { "fullResponse": true, "neverError": true } } }
      },
      "id": "upload-to-github",
      "name": "Upload to GitHub",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [848, 304],
      "credentials": { "githubApi": { "name": "GitHub - Workflow Backup" } }
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict", "version": 1 },
          "conditions": [{ "id": "aa86199c-bfb5-4add-ad20-47c6a8d0f90e", "leftValue": "={{ $json.body.status }}", "rightValue": "422", "operator": { "type": "string", "operation": "equals" } }],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-if-file-exists",
      "name": "File Exists?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1072, 304]
    },
    {
      "parameters": {
        "url": "=https://api.github.com/repos/dougkimmerly/homelab-n8n-workflows/contents/{{ $('Process Workflows').item.json.filename }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "options": { "response": { "response": { "fullResponse": true, "neverError": true } } }
      },
      "id": "get-file-sha",
      "name": "Get File SHA",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1280, 208],
      "credentials": { "githubApi": { "name": "GitHub - Workflow Backup" } }
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://api.github.com/repos/dougkimmerly/homelab-n8n-workflows/contents/{{ $('Process Workflows').item.json.filename }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"message\": \"Updated {{ $json.workflowName }}\",\n  \"content\": \"{{ $json.content }}\",\n  \"branch\": \"main\",\n  \"sha\": \"{{ $(\"Get File SHA\").item.json.body.sha }}\"\n}",
        "options": { "response": { "response": { "neverError": true } } }
      },
      "id": "update-existing-file",
      "name": "Update Existing File",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1504, 208],
      "credentials": { "githubApi": { "name": "GitHub - Workflow Backup" } }
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://api.github.com/repos/dougkimmerly/homelab-n8n-workflows/contents/README.md",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"message\": \"Auto-updated README\",\n  \"content\": \"{{ $json.readmeContent }}\",\n  \"branch\": \"main\",\n  \"sha\": \"{{ $('Get README SHA').item.json.body.sha }}\"\n}",
        "options": { "response": { "response": { "neverError": true } } }
      },
      "id": "update-readme",
      "name": "Update README",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2016, 496],
      "credentials": { "githubApi": { "name": "GitHub - Workflow Backup" } }
    }
  ],
  "connections": {
    "Schedule Trigger": { "main": [[{ "node": "Get All Workflows", "type": "main", "index": 0 }]] },
    "Get All Workflows": { "main": [[{ "node": "Process Workflows", "type": "main", "index": 0 }]] },
    "Process Workflows": { "main": [[{ "node": "Upload to GitHub", "type": "main", "index": 0 }]] },
    "Upload to GitHub": { "main": [[{ "node": "File Exists?", "type": "main", "index": 0 }]] },
    "File Exists?": { "main": [[{ "node": "Get File SHA", "type": "main", "index": 0 }], [{ "node": "Create Summary", "type": "main", "index": 0 }]] },
    "Get File SHA": { "main": [[{ "node": "Update Existing File", "type": "main", "index": 0 }]] },
    "Update Existing File": { "main": [[{ "node": "Create Summary", "type": "main", "index": 0 }]] },
    "Create Summary": { "main": [[{ "node": "Get README SHA", "type": "main", "index": 0 }]] },
    "Get README SHA": { "main": [[{ "node": "Merge README Data", "type": "main", "index": 0 }]] },
    "Merge README Data": { "main": [[{ "node": "Update README", "type": "main", "index": 0 }]] }
  },
  "settings": { "executionOrder": "v1", "availableInMCP": true },
  "triggerCount": 1
}
