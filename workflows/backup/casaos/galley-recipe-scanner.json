{
  "id": "jhz0aTSMaqnbHddS",
  "name": "Galley Recipe Scanner",
  "active": true,
  "createdAt": "2025-12-16T22:16:43.791Z",
  "updatedAt": "2025-12-21T01:47:12.973Z",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [{ "triggerAtHour": 6 }]
        }
      },
      "name": "Daily 6am1",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [7840, 3600],
      "id": "d4dbe251-a1ac-4877-b609-a124d16130e3"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "scanner-trigger",
        "options": {}
      },
      "name": "Trigger Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [7840, 3408],
      "webhookId": "2bf76818-c400-41a3-a9b2-5f3e418568a5",
      "id": "5a0bc1e0-1b41-4417-b3f2-69210ed6aa9f"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "resource": "fileFolder",
        "searchMethod": "query",
        "queryString": "'1GfSx6VyB9FqFkmpjX2-wB2q-sptbxbf3' in parents and trashed = false and mimeType != 'application/vnd.google-apps.folder'",
        "returnAll": true,
        "filter": {},
        "options": {}
      },
      "name": "List Scanned Recipes1",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [8064, 3504],
      "id": "4f165686-1429-4a24-9cf3-29f4a7a66d37",
      "credentials": { "googleApi": { "name": "Google Service Account account" } }
    },
    {
      "parameters": {
        "conditions": {
          "options": { "leftValue": "", "caseSensitive": true, "typeValidation": "strict" },
          "combinator": "and",
          "conditions": [
            { "leftValue": "={{ $json.mimeType }}", "rightValue": "application/vnd.google-apps.folder", "operator": { "type": "string", "operation": "notEquals" } }
          ]
        },
        "options": {}
      },
      "name": "Filter Files Only1",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [8288, 3504],
      "id": "86e4b84b-fd4b-47cd-95ef-9e698f36070c"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "download",
        "fileId": { "__rl": true, "value": "={{ $json.id }}", "mode": "id" },
        "options": {}
      },
      "name": "Download File1",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [8512, 3504],
      "id": "3411e569-648e-4f61-93bb-903e8620c41b",
      "credentials": { "googleApi": { "name": "Google Service Account account" } }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const filename = $input.item.json.name || '';\nconst ext = filename.toLowerCase().split('.').pop();\nconst mimeType = $input.item.json.mimeType || '';\nconst fileId = $input.item.json.id;\n\nreturn {\n  json: {\n    fileId: fileId,\n    filename: filename,\n    fileExtension: ext,\n    mimeType: mimeType\n  },\n  binary: {\n    data: $input.item.binary.data\n  }\n};"
      },
      "name": "Extract Metadata",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [8736, 3504],
      "id": "d05d1c9f-2d30-4d76-b2c9-7a66a15d6e4c"
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict", "version": 1 },
          "conditions": [
            { "leftValue": "={{ $json.fileExtension }}", "rightValue": "pdf", "operator": { "type": "string", "operation": "equals" }, "id": "0d81d906-a80f-4372-ba35-52d5d0f2e14e" }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Is PDF?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [9184, 3504],
      "id": "a88d211c-89d0-4c8b-9602-abd93506c8c4"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "anthropicApi",
        "sendHeaders": true,
        "headerParameters": { "parameters": [{ "name": "anthropic-version", "value": "2023-06-01" }] },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.apiRequest) }}",
        "options": { "batching": { "batch": { "batchSize": 1, "batchInterval": 5000 } } }
      },
      "name": "Claude Extract PDF",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [9856, 3408],
      "id": "ed516388-40a4-40c7-8604-c69672ef2525",
      "credentials": { "anthropicApi": { "name": "Anthropic account" } }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "anthropicApi",
        "sendHeaders": true,
        "headerParameters": { "parameters": [{ "name": "anthropic-version", "value": "2023-06-01" }] },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.apiRequest) }}",
        "options": { "batching": { "batch": { "batchSize": 1, "batchInterval": 5000 } } }
      },
      "name": "Claude Extract Image",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [9856, 3600],
      "id": "5e1587e8-3fbb-48f3-a7cd-d5d8f4f0371e",
      "credentials": { "anthropicApi": { "name": "Anthropic account" } }
    },
    {
      "parameters": {
        "resource": "file",
        "owner": { "__rl": true, "value": "dougkimmerly", "mode": "list" },
        "repository": { "__rl": true, "value": "galley-meal-planner", "mode": "list" },
        "filePath": "={{ 'pending-recipes/' + $now.format('yyyy-MM-dd') + '_' + $json.source_file.replace(/\\.[^/.]+$/, '') + '.json' }}",
        "fileContent": "={{ JSON.stringify($json, null, 2) }}",
        "commitMessage": "={{ 'Add scanned recipe: ' + ($json.recipes[0]?.name || $json.source_file) }}"
      },
      "name": "Push to Pending",
      "type": "n8n-nodes-base.github",
      "typeVersion": 1,
      "position": [11424, 3216],
      "id": "f68e5ca0-b095-4377-8fbc-ac3f164e7679",
      "credentials": { "githubApi": { "name": "GitHub - Workflow Backup" } }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "move",
        "fileId": { "__rl": true, "value": "={{ $json.fileId }}", "mode": "id" },
        "driveId": { "__rl": true, "mode": "list", "value": "My Drive" },
        "folderId": { "__rl": true, "value": "1bjJJgjGRezDcWhPCd3a3GHqp-txxEOLA", "mode": "id" }
      },
      "name": "Move to Processed (Success)",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [11424, 3408],
      "id": "ce8d1634-8bb7-47c4-a17d-08752175dce9",
      "credentials": { "googleApi": { "name": "Google Service Account account" } }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://192.168.20.16:3122/api/scans/upload-and-split",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"file\": $json.file_base64, \"filename\": $json.filename, \"recipes\": $json.recipes } }}",
        "options": { "timeout": 60000 }
      },
      "name": "Upload Scan to Galley",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [10976, 3312],
      "id": "fe6b1c16-f8ad-470c-b66a-f0d25706e91a",
      "continueOnFail": true
    }
  ],
  "connections": {
    "Daily 6am1": { "main": [[{ "node": "List Scanned Recipes1", "type": "main", "index": 0 }]] },
    "Trigger Webhook": { "main": [[{ "node": "List Scanned Recipes1", "type": "main", "index": 0 }]] },
    "List Scanned Recipes1": { "main": [[{ "node": "Filter Files Only1", "type": "main", "index": 0 }]] },
    "Filter Files Only1": { "main": [[{ "node": "Download File1", "type": "main", "index": 0 }]] },
    "Download File1": { "main": [[{ "node": "Extract Metadata", "type": "main", "index": 0 }]] },
    "Extract Metadata": { "main": [[{ "node": "Preserve File as Base64", "type": "main", "index": 0 }]] },
    "Is PDF?": { "main": [[{ "node": "Extract From File (PDF to Base64)", "type": "main", "index": 0 }], [{ "node": "Build Image Request", "type": "main", "index": 0 }]] },
    "Claude Extract PDF": { "main": [[{ "node": "Preserve PDF Metadata", "type": "main", "index": 0 }]] },
    "Claude Extract Image": { "main": [[{ "node": "Preserve Image Metadata", "type": "main", "index": 0 }]] },
    "Check Confidence": { "main": [[{ "node": "Preserve Binary for Galley Upload", "type": "main", "index": 0 }], [{ "node": "Push to Failed", "type": "main", "index": 0 }, { "node": "Move to Processed (Failed)", "type": "main", "index": 0 }]] },
    "Upload Scan to Galley": { "main": [[{ "node": "Merge Scan Paths", "type": "main", "index": 0 }]] },
    "Merge Scan Paths": { "main": [[{ "node": "Push to Pending", "type": "main", "index": 0 }, { "node": "Move to Processed (Success)", "type": "main", "index": 0 }]] }
  },
  "settings": { "executionOrder": "v1" },
  "triggerCount": 2
}
