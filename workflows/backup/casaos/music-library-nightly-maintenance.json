{
  "id": "wchLTqQ48tNI7bZk",
  "name": "Music Library Nightly Maintenance",
  "active": true,
  "createdAt": "2025-12-19T15:34:37.594Z",
  "updatedAt": "2025-12-19T22:34:35.751Z",
  "nodes": [
    {
      "parameters": {
        "rule": { "interval": [{ "field": "cronExpression", "expression": "0 2 * * *" }] }
      },
      "id": "852f5a4e-8293-439e-a429-dc1902a7bb8a",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [-1008, 96],
      "notes": "Runs every night at 2:00 AM"
    },
    {
      "parameters": {
        "url": "http://192.168.20.16:3847/api/health",
        "options": { "timeout": 30000 }
      },
      "id": "health-check-node",
      "name": "API Health Check",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [-784, 96],
      "notes": "Verify API is reachable before starting maintenance"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://192.168.20.16:3847/api/actions/maintenance",
        "sendBody": true,
        "bodyParameters": { "parameters": [{ "name": "lyricsLimit", "value": 100 }, { "name": "enrichLimit", "value": 50 }] },
        "options": { "timeout": 30000 }
      },
      "id": "51784375-50f6-4bb8-b6a3-d1a6157daa3a",
      "name": "Start Maintenance",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [-560, 96],
      "notes": "Triggers maintenance endpoint with 30s timeout"
    },
    {
      "parameters": {
        "conditions": { "string": [{ "value1": "={{ $json.error }}", "operation": "exists" }] },
        "options": {}
      },
      "id": "start-error-check",
      "name": "Start Failed?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [-336, 96],
      "notes": "Check if Start Maintenance failed"
    },
    {
      "parameters": { "amount": 30 },
      "id": "1948f0e5-462e-4a5e-87f7-57cc56e4b841",
      "name": "Wait 30s",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [112, 208],
      "notes": "Wait before first status check"
    },
    {
      "parameters": {
        "url": "=http://192.168.20.16:3847/api/jobs/{{ $json.jobId }}",
        "options": { "timeout": 30000 }
      },
      "id": "b5a00063-c272-402f-b052-0f96fcbc8f9b",
      "name": "Check Job Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [336, 208],
      "notes": "Polls job status with 30s timeout and 3 retries"
    },
    {
      "parameters": {
        "conditions": {
          "options": { "combineOperation": "any" },
          "conditions": [
            { "id": "status_complete", "leftValue": "={{ $json.status }}", "rightValue": "complete", "operator": { "type": "string", "operation": "equals" } },
            { "id": "status_error", "leftValue": "={{ $json.status }}", "rightValue": "error", "operator": { "type": "string", "operation": "equals" } },
            { "id": "status_partial", "leftValue": "={{ $json.status }}", "rightValue": "partial", "operator": { "type": "string", "operation": "equals" } },
            { "id": "max_iterations_reached", "leftValue": "={{ $json.iteration_count }}", "rightValue": "={{ $json.max_iterations }}", "operator": { "type": "number", "operation": "gte" } }
          ]
        },
        "options": {}
      },
      "id": "efd4d0b9-24fc-4a17-9fcc-7ac55c01b6e3",
      "name": "Job Done or Timeout?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [784, 208],
      "notes": "Exit if complete/error OR max 2 hours polling (120 iterations)"
    },
    { "parameters": { "amount": 60 }, "id": "372293d6-05dc-43b9-9fe8-dae770be82d8", "name": "Wait 60s", "type": "n8n-nodes-base.wait", "typeVersion": 1.1, "position": [1168, 224], "notes": "Wait before next status check" }
  ],
  "connections": {
    "API Health Check": { "main": [[{ "node": "Start Maintenance", "type": "main", "index": 0 }]] },
    "Start Maintenance": { "main": [[{ "node": "Start Failed?", "type": "main", "index": 0 }]] },
    "Start Failed?": { "main": [[{ "node": "Log Start Error", "type": "main", "index": 0 }], [{ "node": "Initialize Counter", "type": "main", "index": 0 }]] },
    "Initialize Counter": { "main": [[{ "node": "Wait 30s", "type": "main", "index": 0 }]] },
    "Wait 30s": { "main": [[{ "node": "Check Job Status", "type": "main", "index": 0 }]] },
    "Check Job Status": { "main": [[{ "node": "Preserve Job Data", "type": "main", "index": 0 }]] },
    "Preserve Job Data": { "main": [[{ "node": "Job Done or Timeout?", "type": "main", "index": 0 }]] },
    "Job Done or Timeout?": { "main": [[{ "node": "Format Results", "type": "main", "index": 0 }], [{ "node": "Increment Counter", "type": "main", "index": 0 }]] },
    "Increment Counter": { "main": [[{ "node": "Wait 60s", "type": "main", "index": 0 }]] },
    "Wait 60s": { "main": [[{ "node": "Check Job Status", "type": "main", "index": 0 }]] },
    "Format Results": { "main": [[{ "node": "Build Summary", "type": "main", "index": 0 }]] }
  },
  "settings": { "executionOrder": "v1", "availableInMCP": true },
  "triggerCount": 1
}
